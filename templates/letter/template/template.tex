\BLOCK{ if use_lettre }
\documentclass[12pt]{lettre}
\usepackage{fontspec}
\usepackage[\VAR{babel_language|default('french')}]{babel}
\usepackage{csquotes}
\BLOCK{ if use_cursive_signature }
\setmainfont[Path=fonts/,Extension=.otf,Ligatures=Common,Mapping=]{modernline}
\newcommand{\TexsmithLetterEndash}{\kern0.05em-\kern0.05em}
\newcommand{\TexsmithLetterEmdash}{\kern0.05em-\kern0.05em-\kern0.05em}
\catcode"2013=\active
\catcode"2014=\active
\begingroup\lccode`~="2013\lowercase{\endgroup\protected\def~}{\TexsmithLetterEndash}
\begingroup\lccode`~="2014\lowercase{\endgroup\protected\def~}{\TexsmithLetterEmdash}
\BLOCK{ endif }
\BLOCK{ if use_cursive_signature }
\newfontfamily\SignatureFont[Path=fonts/,Extension=.otf]{modernline}
\newcommand{\SignatureText}[1]{{\SignatureFont #1}}
\BLOCK{ else }
\newcommand{\SignatureText}[1]{#1}
\BLOCK{ endif }
\makeatletter
\BLOCK{ if not fold_marks_enabled }\def\rule@length{0}\BLOCK{ endif }
\makeatother

\newcommand{\LetterSenderSetup}{%
  \name{\VAR{from_name}}%
  \address{%
  \BLOCK{ if has_sender_address }
  \BLOCK{ for line in from_address_lines }
  \VAR{line}\BLOCK{ if not loop.last }\\\BLOCK{ endif }
  \BLOCK{ endfor }
  \BLOCK{ endif }
  }%
  \notelephone
  \nofax
  \BLOCK{ if from_location_value }\lieu{\VAR{from_location_value}}\BLOCK{ endif }%
  \date{\VAR{date_value}}%
  \BLOCK{ if has_subject }\conc{\VAR{object_value}}\BLOCK{ endif }%
  \signature{\SignatureText{\VAR{signature_text}}}%
}

\begin{document}

\begin{letter}{%
\BLOCK{ if has_recipient_address }
\BLOCK{ for line in to_address_lines }
\VAR{line}\BLOCK{ if not loop.last }\\\BLOCK{ endif }
\BLOCK{ endfor }
\BLOCK{ else }
\VAR{to_name}
\BLOCK{ endif }
}
\LetterSenderSetup

\opening{\VAR{opening_text}}

\VAR{mainmatter}

\closing{\VAR{closing_text}}

\end{letter}

\end{document}
\BLOCK{ else }
\documentclass[%
  paper=a4,
  fontsize=11pt,
  parskip=half,
  fromalign=left,
  enlargefirstpage=true,
]{scrlttr2}
\usepackage{fontspec}
\usepackage[\VAR{babel_language|default('english')}]{babel}
\usepackage{csquotes}
\KOMAoptions{fromrule=afteraddress}
\KOMAoptions{foldmarks=\VAR{foldmarks_option}}
\BLOCK{ if use_cursive_signature }
\setmainfont[Path=fonts/,Extension=.otf,Ligatures=Common,Mapping=]{modernline}
\newcommand{\TexsmithLetterEndash}{\kern0.05em-\kern0.05em}
\newcommand{\TexsmithLetterEmdash}{\kern0.05em-\kern0.05em-\kern0.05em}
\catcode"2013=\active
\catcode"2014=\active
\begingroup\lccode`~="2013\lowercase{\endgroup\protected\def~}{\TexsmithLetterEndash}
\begingroup\lccode`~="2014\lowercase{\endgroup\protected\def~}{\TexsmithLetterEmdash}
\BLOCK{ endif }

\BLOCK{ if use_cursive_signature }
\newfontfamily\SignatureFont[Path=fonts/,Extension=.otf]{modernline}
\newcommand{\SignatureText}[1]{{\SignatureFont #1}}
\BLOCK{ else }
\newcommand{\SignatureText}[1]{#1}
\BLOCK{ endif }

\setkomavar{fromname}{\VAR{from_name}}
\setkomavar{fromaddress}{%
\BLOCK{ if has_sender_address }
\BLOCK{ for line in from_address_lines }
\VAR{line}\BLOCK{ if not loop.last }\\\BLOCK{ endif }
\BLOCK{ endfor }
\BLOCK{ endif }
}
\BLOCK{ if from_location_value }\setkomavar{location}{\VAR{from_location_value}}\BLOCK{ endif }
\setkomavar{date}{\VAR{date_value}}
\BLOCK{ if has_subject }
\setkomavar{subject}{\VAR{object_value}}
\setkomavar*{subject}{Subject:~}
\BLOCK{ endif }
\setkomavar{signature}{\SignatureText{\VAR{signature_text}}}

\begin{document}

\begin{letter}{%
\BLOCK{ if has_recipient_address }
\BLOCK{ for line in to_address_lines }
\VAR{line}\BLOCK{ if not loop.last }\\\BLOCK{ endif }
\BLOCK{ endfor }
\BLOCK{ else }
\VAR{to_name}
\BLOCK{ endif }
}

\opening{\VAR{opening_text}}

\VAR{mainmatter}

\closing{%
\VAR{closing_text}%
\\[2\baselineskip]%
\SignatureText{\VAR{signature_text}}%
}

\end{letter}

\end{document}
\BLOCK{ endif }
