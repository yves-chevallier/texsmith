\documentclass\BLOCK{ if class_options and class_options.strip() }[\VAR{class_options}]\BLOCK{ endif }{book}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{natbib}
\usepackage[\VAR{babel_languages}]{babel}
\usepackage{lmodern}
\usepackage{fourier}
\usepackage{setspace}
\setstretch{1.1}

\setlength{\textwidth}{146.8mm}
\setlength{\oddsidemargin}{11.6mm}
\setlength{\evensidemargin}{0.8mm}
\setlength{\topmargin}{-2.2mm}
\setlength{\textheight}{221.9mm}
\setlength{\headheight}{14mm}

\makeatletter
\setlength{\@fptop}{0pt}
\makeatother

\usepackage{graphicx}
\graphicspath{{./}{./assets/}}
\usepackage{xcolor}
\usepackage{subfig}
\usepackage{float}
\usepackage{booktabs}
\usepackage{microtype}
\usepackage{url}
\usepackage{minted}
\usepackage[many,minted]{tcolorbox}
\tcbuselibrary{skins, breakable, minted}
\usepackage{newunicodechar}
\newunicodechar{ε}{\ensuremath{\varepsilon}}
\newunicodechar{̇}{\ensuremath{\dot{\phantom{m}}}}
\newunicodechar{⁻}{\textsuperscript{-}}
\newunicodechar{°}{\ensuremath{^\circ}}
\setminted{fontsize=\footnotesize, breaklines, autogobble, tabsize=4}
\usemintedstyle{friendly}

\newtcblisting[auto counter,number within=chapter,
  list inside=epflcodelist]{code}[4][]{%
  breakable,
  listing only,
  enhanced,
  colback=white,
  pad at break*=1mm,
  toptitle=0.15em,
  bottomtitle=0.1em,
  boxrule=0mm,
  frame hidden,
  minted language=#2,
  top=1mm,
  bottom=1mm,
  minted options={%
      breaklines,
      tabsize=4,
      autogobble,
      fontsize=\footnotesize,
      highlightcolor=yellow!20,
      #4
    },
  title={#3},
  list entry={\protect\numberline{\thetcbcounter}#3},
  #1
}

\usepackage{fancyhdr}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhead[OR]{\bfseries \nouppercase{\rightmark}}
\fancyhead[EL]{\bfseries \nouppercase{\leftmark}}
\fancyfoot[EL,OR]{\thepage}
\fancypagestyle{plain}{
    \fancyhf{}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
    \fancyfoot[EL,OR]{\thepage}
}
\fancypagestyle{addpagenumbersforpdfimports}{
    \fancyhead{}
    \renewcommand{\headrulewidth}{0pt}
    \fancyfoot{}
    \fancyfoot[RO,LE]{\thepage}
}

\usepackage{hyperref}
\hypersetup{
    pdfborder={0 0 0},
    colorlinks=true,
    linkcolor=black,
    citecolor=black,
    urlcolor=black
}
\urlstyle{same}
\usepackage{bookmark}

\makeatletter
\renewcommand\@pnumwidth{20pt}
\def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else
    \hbox{}\thispagestyle{empty}\newpage
    \if@twocolumn\hbox{}\newpage\fi\fi\fi}
\makeatother
\clearpage{\pagestyle{plain}\cleardoublepage}

\usepackage{tikz}
\usepackage[explicit]{titlesec}
\newcommand*\chapterlabel{}
\titleformat{\chapter}[display]
  {\normalfont\bfseries\Huge}
  {\gdef\chapterlabel{\thechapter\ }}
  {0pt}
  {%
    \begin{tikzpicture}[remember picture,overlay]
      \node[yshift=-8cm] at (current page.north west)
        {\begin{tikzpicture}[remember picture, overlay]
            \draw[fill=black] (0,0) rectangle(35.5mm,15mm);
            \node[anchor=north east,yshift=-7.2cm,xshift=34mm,minimum height=30mm,inner sep=0mm] at (current page.north west)
              {\parbox[top][30mm][t]{15mm}{\raggedleft \rule{0cm}{0.6cm}\color{white}\chapterlabel}};
            \node[anchor=north west,yshift=-7.2cm,xshift=37mm,text width=\textwidth,minimum height=30mm,inner sep=0mm] at (current page.north west)
              {\parbox[top][30mm][t]{\textwidth}{\rule{0cm}{0.6cm}\color{black}#1}};
          \end{tikzpicture}};
    \end{tikzpicture}
    \gdef\chapterlabel{}
  }
\titlespacing*{name=\chapter,numberless}{-3.7cm}{83.2pt-\parskip}{-3.2pt+\parskip}
\titlespacing*{\chapter}{-3.7cm}{50pt-\parskip-\parskip}{30pt+\parskip+\parskip}
\titlespacing*{\section}{0pt}{13.2pt}{1em-\parskip}
\titlespacing*{\subsection}{0pt}{13.2pt}{1em-\parskip}
\titlespacing*{\subsubsection}{0pt}{13.2pt}{1em-\parskip}
\titlespacing*{\paragraph}{0pt}{13.2pt}{1em-\parskip}

\newcounter{myparts}
\newcommand*\partlabel{}
\titleformat{\part}[display]
  {\normalfont\bfseries\Huge}
  {\gdef\partlabel{\thepart\ }}
  {0pt}
  {%
    \ifpdf\setlength{\unitlength}{20mm}\else\setlength{\unitlength}{0mm}\fi
    \addtocounter{myparts}{1}
    \begin{tikzpicture}[remember picture,overlay]
      \node[anchor=north west,xshift=-65mm,yshift=-6.9cm-\value{myparts}*20mm] at (current page.north east)
        {\begin{tikzpicture}[remember picture, overlay]
            \draw[fill=black] (0,0) rectangle(62mm,20mm);
            \node[anchor=north west,yshift=-6.1cm-\value{myparts}*\unitlength,xshift=-60.5mm,minimum height=30mm,inner sep=0mm] at (current page.north east)
              {\parbox[top][30mm][t]{55mm}{\raggedright \color{white}Part \partlabel \rule{0cm}{0.6cm}}};
            \node[anchor=north east,yshift=-6.1cm-\value{myparts}*\unitlength,xshift=-63.5mm,text width=\textwidth,minimum height=30mm,inner sep=0mm] at (current page.north east)
              {\parbox[top][30mm][t]{\textwidth}{\raggedleft \rule{0cm}{0.6cm}\color{black}#1}};
          \end{tikzpicture}};
    \end{tikzpicture}
    \gdef\partlabel{}
  }
\titlespacing*{\part}{11.06cm}{26.4pt-\parskip-\parskip}{0pt}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{mathtools}
\makeatletter
\def\resetMathstrut@{%
  \setbox\z@\hbox{%
    \mathchardef\@tempa\mathcode`\(\relax
      \def\@tempb##1"##2##3{\the\textfont"##3\char"}%
      \expandafter\@tempb\meaning\@tempa \relax
  }%
  \ht\Mathstrutbox@1.2\ht\z@ \dp\Mathstrutbox@1.2\dp\z@
}
\makeatother

\begin{document}
\selectlanguage{\VAR{document_language}}

\frontmatter
\setlength{\parindent}{0pt}
\setlength{\parskip}{0pt}

\begin{titlepage}
\BLOCK{ if title_language and title_language.strip() and title_language.strip().lower() != document_language }
\begin{otherlanguage}{\VAR{title_language|escape_latex}}
\BLOCK{ endif }
\begin{center}
\sffamily
\null\vspace{2cm}
\BLOCK{ if title_lines }
{\huge
\BLOCK{ for line in title_lines }
\VAR{line|escape_latex}\BLOCK{ if not loop.last }\\[12pt]\BLOCK{ endif }
\BLOCK{ endfor }
}%
\BLOCK{ endif }
\BLOCK{ if subtitle and subtitle.strip() }\\[12pt]
{\Large \VAR{subtitle|escape_latex}}
\BLOCK{ endif }\\[24pt]
\BLOCK{ if title_notice and title_notice.strip() }
{\textcolor{gray}{\small{\VAR{title_notice|escape_latex}}}}\\[24pt]
\BLOCK{ endif }

\vfill

\begin{tabular}{cc}
\parbox{0.3\textwidth}{\includegraphics[width=4cm]{epfl-logo}} &
\parbox{0.7\textwidth}{%
\BLOCK{ if thesis_number and thesis_number.strip() }
Thèse n.\ \VAR{thesis_number|escape_latex}\\
\BLOCK{ endif }
présentée le \BLOCK{ if defense_date and defense_date.strip() }\VAR{defense_date|escape_latex}\BLOCK{ else }\today\BLOCK{ endif }\\
\BLOCK{ if faculty and faculty.strip() }\VAR{faculty|escape_latex}\\\BLOCK{ endif }
\BLOCK{ if laboratory and laboratory.strip() }\VAR{laboratory|escape_latex}\\\BLOCK{ endif }
\BLOCK{ if doctoral_program and doctoral_program.strip() }programme doctoral en \VAR{doctoral_program|escape_latex}\\\BLOCK{ endif }
École polytechnique fédérale de Lausanne\\[6pt]
\BLOCK{ if degree and degree.strip() }pour l'obtention du grade de \VAR{degree|escape_latex}\\\BLOCK{ endif }
par\\[4pt]
\null\hspace{3em}\VAR{author|escape_latex}\\[9pt]
\BLOCK{ if supervisors }
{\small Encadrement scientifique :\\[4pt]
\BLOCK{ for supervisor in supervisors }
\VAR{supervisor|escape_latex}\BLOCK{ if not loop.last }\\\BLOCK{ endif }
\BLOCK{ endfor }}\\[12pt]
\BLOCK{ endif }
\BLOCK{ if jury_entries }
{\small acceptée sur proposition du jury:\\[4pt]
\BLOCK{ for member in jury_entries }
\VAR{member.name|escape_latex}\BLOCK{ if member.role }\,(\VAR{member.role|escape_latex})\BLOCK{ endif }\\
\BLOCK{ endfor }}\\[12pt]
\BLOCK{ endif }
\BLOCK{ if location and location.strip() }
\VAR{location|escape_latex}
\BLOCK{ else }
Lausanne, EPFL, \the\year
\BLOCK{ endif }
}
\end{tabular}
\end{center}
\vspace{2cm}
\BLOCK{ if title_language and title_language.strip() and title_language.strip().lower() != document_language }
\end{otherlanguage}
\BLOCK{ endif }
\end{titlepage}

\setcounter{page}{1}

\BLOCK{ if dedication and dedication.strip() }
\cleardoublepage
\thispagestyle{empty}
\vspace*{0.3\textheight}
\begin{flushright}
\itshape \VAR{dedication}
\end{flushright}
\BLOCK{ endif }

\BLOCK{ if acknowledgements and acknowledgements.strip() }
\cleardoublepage
\chapter*{Acknowledgements}
\markboth{Acknowledgements}{Acknowledgements}
\addcontentsline{toc}{chapter}{Acknowledgements}
\VAR{acknowledgements}
\BLOCK{ endif }

\BLOCK{ if preface and preface.strip() }
\cleardoublepage
\chapter*{Preface}
\markboth{Preface}{Preface}
\addcontentsline{toc}{chapter}{Preface}
\VAR{preface}
\BLOCK{ endif }

\BLOCK{ if abstract_sections }
\BLOCK{ set languages_label = abstract_toc_label }
\BLOCK{ for section in abstract_sections }
\cleardoublepage
\BLOCK{ if section.language and section.language != document_language }
\begin{otherlanguage}{\VAR{section.language|escape_latex}}
\BLOCK{ endif }
\chapter*{\VAR{section.title|escape_latex}}
\markboth{\VAR{section.title|escape_latex}}{\VAR{section.title|escape_latex}}
\BLOCK{ if loop.first }
\addcontentsline{toc}{chapter}{Abstract (\VAR{languages_label|escape_latex})}
\BLOCK{ endif }
\VAR{section.content}
\BLOCK{ if section.language and section.language != document_language }
\end{otherlanguage}
\BLOCK{ endif }
\BLOCK{ endfor }
\BLOCK{ endif }

\BLOCK{ if frontmatter and frontmatter.strip() }
\cleardoublepage
\VAR{frontmatter}
\BLOCK{ endif }

\cleardoublepage
\pdfbookmark{\contentsname}{toc}
\tableofcontents

\setlength{\parskip}{1em}

\mainmatter
\pagestyle{fancy}
\VAR{mainmatter}

\BLOCK{ if appendix and appendix.strip() }
\bookmarksetup{startatroot}
\appendix
\VAR{appendix}
\BLOCK{ endif }

\backmatter
\BLOCK{ if backmatter and backmatter.strip() }
\VAR{backmatter}
\BLOCK{ endif }

\BLOCK{ if bibliography_style and bibliography_style.strip() }
\bibliographystyle{\VAR{bibliography_style|escape_latex}}
\BLOCK{ endif }

\BLOCK{ if bibliography and bibliography.strip() }
\bibliography{\VAR{bibliography|escape_latex}}
\BLOCK{ endif }

\BLOCK{ if cv and cv.strip() }
\cleardoublepage
\chapter*{Curriculum Vitae}
\markboth{Curriculum Vitae}{Curriculum Vitae}
\addcontentsline{toc}{chapter}{Curriculum Vitae}
\VAR{cv}
\BLOCK{ endif }

\end{document}
