\documentclass\VAR{documentclass_options}{article}

\usepackage{fontspec}
\usepackage{microtype}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage{hyphenat}
\usepackage[\VAR{language|default('english')}]{babel}
\usepackage{booktabs}
\usepackage[many,minted]{tcolorbox}

\BLOCK{ if acronyms }
\usepackage[acronym]{glossaries}
\makeglossaries
\BLOCK{ endif }
\BLOCK{ if index_entries }\usepackage{imakeidx}\BLOCK{ endif }

\setmonofont{CMU Typewriter Text}
\usemintedstyle{bw}

\newtcblisting[auto counter,number within=section,
  list inside=mypyg]{code}[4][]{%
  breakable,
  listing only,
  enhanced,
  colback=white,
  pad at break*=1mm,
  toptitle=0.15em,
  bottomtitle=0.1em,
  boxrule=0mm,
  frame hidden,
  minted language=#2,
  top=1mm,
  bottom=1mm,
  minted options={%
      tabsize=4,
      breaklines,
      xleftmargin=-0.75em,
      fontsize=\footnotesize,
      highlightcolor=gray!30,
      ignorelexererrors,
      #4
    },
  title={#3},
  list entry={\protect\numberline{\thetcbcounter}#3},
  #1
}

\geometry{\VAR{geometry_options}}

\title{\VAR{title}\BLOCK{ if subtitle }\\\large \VAR{subtitle}\BLOCK{ endif }}
\author{\VAR{author}}
\date{\VAR{date}}

\BLOCK{ if acronyms }
\BLOCK{ for key, entry in acronyms.items() }
\BLOCK{ set pair = entry if (entry is sequence and not entry is string) else [key, entry] }
\newacronym{\VAR{key}}{\VAR{pair[0]|latex_escape}}{\VAR{pair[1]|latex_escape}}
\BLOCK{ endfor }
\BLOCK{ endif }

\begin{document}

\BLOCK{ if index_entries }\makeindex\BLOCK{ endif }

\maketitle

\VAR{mainmatter}

\BLOCK{ if acronyms }\printglossary[type=\acronymtype, title=Liste des acronymes]\BLOCK{ endif }
\BLOCK{ if index_entries }\printindex\BLOCK{ endif }

\BLOCK{ if citations }
\begin{thebibliography}{\VAR{citations|length}}
\BLOCK{ for key in citations }
\BLOCK{ set entry = bibliography_entries.get(key) }
\bibitem{\VAR{key}}%
\BLOCK{ if entry }
\BLOCK{ set fields = entry['fields'] }
\BLOCK{ set persons = entry['persons'] }
\BLOCK{ set authors = persons.get('author', []) }
\BLOCK{ if authors }\VAR{ authors | map(attribute='text') | join(', ') }\BLOCK{ endif }%
\BLOCK{ if fields.get('title') } \textit{\VAR{fields['title']}}\BLOCK{ endif }%
\BLOCK{ if fields.get('journal') } \VAR{fields['journal']}\BLOCK{ endif }%
\BLOCK{ if fields.get('year') } (\VAR{fields['year']})\BLOCK{ endif }%
\BLOCK{ if fields.get('url') }\\\url{\VAR{fields['url']}}\BLOCK{ endif }%
\BLOCK{ if fields.get('doi') }\\\textsc{doi}: \VAR{fields['doi']}\BLOCK{ endif }
\BLOCK{ else }
Missing bibliography entry for \VAR{key}
\BLOCK{ endif }
\BLOCK{ endfor }
\end{thebibliography}
\BLOCK{ endif }

\end{document}
