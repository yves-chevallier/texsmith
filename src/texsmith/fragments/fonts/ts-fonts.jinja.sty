\BLOCK{ set font_family = fonts_family | default("lm") }
\BLOCK{ set fallback = fonts.get("fallback") if fonts is defined and fonts else {} }
\ProvidesPackage{ts-fonts}[2025/01/10 TeXSmith font selection (generated)]

\RequirePackage{iftex}
% Fallback definition replaced when emoji fonts are available.
\providecommand{\texsmithEmoji}[1]{\textbf{!}}
\catcode"2135=\active
\protected\def^^^^2135{\ensuremath{\aleph}}

\ifPDFTeX
  \PackageError{ts-fonts}{ts-fonts requires XeLaTeX or LuaLaTeX}{Switch to xelatex or lualatex.}
\else
  \RequirePackage{fontspec}
  \defaultfontfeatures{Ligatures = TeX, Scale = MatchLowercase}

  \makeatletter
  \newcommand{\tsDeclareFontSet}[2]{%
    \expandafter\gdef\csname tssetupfonts@#1\endcsname{#2}%
  }
  \newcommand{\tsUseFontSet}[1]{%
    \@ifundefined{tssetupfonts@#1}{%
      \PackageError{ts-fonts}{Unknown font family '#1'}%
        {Use one of: lm, lm-sans, bonum, libertinus, pagella, termes, schola, heros, adventor, cursor, plex, pennstander.}%
    }{%
      \csname tssetupfonts@#1\endcsname
    }%
  }
  \makeatother

  % Latin Modern (lm)
  \tsDeclareFontSet{lm}{%
    \ifLuaTeX
      \setmainfont{Latin Modern Roman}%
      \setsansfont{Latin Modern Sans}%
      \setmonofont{Latin Modern Mono}%
    \else
      \setmainfont{lmroman10}[%
        Extension       = .otf,
        UprightFont     = lmroman10-regular,
        ItalicFont      = lmroman10-italic,
        BoldFont        = lmroman10-bold,
        BoldItalicFont  = lmroman10-bolditalic,
        SmallCapsFont   = lmromancaps10-regular,
        SlantedFont     = lmromanslant10-regular,
        BoldSlantedFont = lmromanslant10-bold,
        Ligatures       = TeX,
      ]%
      \setsansfont{lmsans10}[%
        Extension      = .otf,
        UprightFont    = *-regular,
        ItalicFont     = *-oblique,
        BoldFont       = *-bold,
        BoldItalicFont = *-boldoblique,
      ]%
      \setmonofont{lmmono10}[%
        Extension      = .otf,
        UprightFont    = *-regular,
        ItalicFont     = *-italic,
        BoldFont       = *-regular,
        BoldFeatures   = {FakeBold=2},
        BoldItalicFont = *-italic,
        BoldItalicFeatures = {FakeBold=2},
        SmallCapsFont   = lmmonocaps10-regular,
        SmallCapsFeatures = {Letters=SmallCaps},
      ]%
    \fi
  }

  % Latin Modern Sans Serif (lm-sans)
  \tsDeclareFontSet{lm-sans}{%
    \ifLuaTeX
      \setmainfont{Latin Modern Sans}%
      \setsansfont{Latin Modern Sans}%
      \setmonofont{Latin Modern Mono}%
    \else
      \setmainfont{lmsans10}[%
        Extension      = .otf,
        UprightFont    = *-regular,
        ItalicFont     = *-oblique,
        BoldFont       = *-bold,
        BoldItalicFont = *-boldoblique,
        Ligatures      = TeX,
      ]%
      \setsansfont{lmsans10}[%
        Extension      = .otf,
        UprightFont    = *-regular,
        ItalicFont     = *-oblique,
        BoldFont       = *-bold,
        BoldItalicFont = *-boldoblique,
      ]%
      \setmonofont{IBMPlexMono}[%
        Extension      = .otf,
        UprightFont    = *-Regular,
        ItalicFont     = *-Italic,
        BoldFont       = *-Bold,
        BoldItalicFont = *-BoldItalic,
        Scale=0.90,
        FakeStretch    = 0.92,
      ]%
    \fi
  }

  % Tex Gyre Bonum (bonum)
  \tsDeclareFontSet{bonum}{%
    \RequirePackage{bonum-otf}%
  }

  % Libertinus (libertinus)
  \tsDeclareFontSet{libertinus}{%
    \RequirePackage{libertinus}%
  }

  % Tex Gyre Pagella (pagella)
  \tsDeclareFontSet{pagella}{%
    \RequirePackage{pagella-otf}%
  }

  % Tex Gyre Termes (termes)
  \tsDeclareFontSet{termes}{%
    \RequirePackage{termes-otf}%
  }

  % TeX Gyre Schola (schola)
  \tsDeclareFontSet{schola}{%
    \RequirePackage{schola-otf}%
  }

  % TeX Gyre Heros (heros)
  \tsDeclareFontSet{heros}{%
    \RequirePackage{heros-otf}%
  }

  % TeX Gyre Adventor (adventor)
  \tsDeclareFontSet{adventor}{%
    \RequirePackage{adventor-otf}%
  }

  % TeX Gyre Cursor (cursor)
  \tsDeclareFontSet{cursor}{%
    \RequirePackage{cursor-otf}%
  }

  % IBM Plex (plex)
  \tsDeclareFontSet{plex}{%
    \setmainfont{IBMPlexSerif}[%
      Path=./fonts/plex-otf/,%
      UprightFont=*-Regular,%
      ItalicFont=*-Italic,%
      BoldFont=*-Bold,%
      BoldItalicFont=*-BoldItalic,%
    ]%
    \setsansfont{IBMPlexSans}[%
      Path=./fonts/plex-otf/,%
      UprightFont=*-Regular,%
      ItalicFont=*-Italic,%
      BoldFont=*-Bold,%
      BoldItalicFont=*-BoldItalic,%
    ]%
    \setmonofont{IBMPlexMono}[%
      Path=./fonts/plex-otf/,%
      UprightFont=*-Regular,%
      ItalicFont=*-Italic,%
      BoldFont=*-Bold,%
      BoldItalicFont=*-BoldItalic,%
    ]%
  }

  % Penn Stander (pennstander)
  \tsDeclareFontSet{pennstander}{%
    \setmainfont{Latin Modern Roman}%
    \setsansfont{Latin Modern Sans}%
    \setmonofont{Latin Modern Mono}%
  }

  \tsUseFontSet{\VAR{font_family}}

  \BLOCK{- if fallback and fallback.get("entries") }
  % Fallback script fonts
  \makeatletter
  \BLOCK{ for entry in fallback.entries }
  \BLOCK{ set font_cmd = '\\' + entry.font_command }
  \BLOCK{ set text_cmd = '\\' + entry.text_command }
    % Declare font family for \VAR{entry.font_name}
    \newfontfamily\VAR{font_cmd}[
      Path = fonts/,
      Extension = \VAR{entry.extension},
      UprightFont = \VAR{entry.upright},
\BLOCK{ if entry.has_bold }
      BoldFont = \VAR{entry.bold},
\BLOCK{ else }
      FakeBold = 2,
\BLOCK{ endif }
      Scale = MatchLowercase
    ]{\VAR{entry.font_name}}%
    \DeclareRobustCommand\VAR{text_cmd}[1]{{\VAR{font_cmd}#1}}%

  \BLOCK{ endfor }
  \makeatother

\BLOCK{- if fallback and fallback.get("entries") }
  % Ensure hyperref can build PDF strings without font selection commands.
  \makeatletter
  \AtBeginDocument{%
  \BLOCK{ for entry in fallback.entries }
    \BLOCK{ set text_cmd = '\\' + entry.text_command }
      \pdfstringdefDisableCommands{%
        \def\VAR{text_cmd}#1{#1}%
      }%
  \BLOCK{ endfor }
  }
  \makeatother
\BLOCK{- endif }

\BLOCK{- if fallback and fallback.get("missing_commands") }
  % Define no-op wrappers for scripts without an available fallback font.
  \BLOCK{ for text_cmd in fallback.missing_commands }
    \providecommand\VAR{'\\' + text_cmd}[1]{#1}%
  \BLOCK{ endfor }
\BLOCK{- endif }

  \ifLuaTeX
    \directlua{
      luaotfload.add_fallback("texsmith-fallback-reg", {
    \BLOCK{ for font in fallback.lua_regular }
        "[fonts/\VAR{font}]:mode=harf",
    \BLOCK{ endfor }
      })
      luaotfload.add_fallback("texsmith-fallback-bold", {
    \BLOCK{ for font in fallback.lua_bold }
        "[fonts/\VAR{font}]:mode=harf",
    \BLOCK{ endfor }
      })
    }
    \defaultfontfeatures{
      Renderer           = HarfBuzz,
      RawFeature         = {fallback=texsmith-fallback-reg},
      BoldFeatures       = {RawFeature={fallback=texsmith-fallback-bold}},
      ItalicFeatures     = {RawFeature={fallback=texsmith-fallback-reg}},
      BoldItalicFeatures = {RawFeature={fallback=texsmith-fallback-bold}},
    }
    \addfontfeatures{RawFeature={fallback=texsmith-fallback-reg}}
    \ExplSyntaxOn
    \cs_new_protected:Npn \texsmith_apply_fallback_to_family:nn #1#2
      {
        \prop_get:cnNTF { g__fontspec_fontinfo_ #2 _prop } { fontname } \l_tmpa_tl
          {
            #1[
              RawFeature         = {fallback=texsmith-fallback-reg},
              BoldFeatures       = {RawFeature={fallback=texsmith-fallback-bold}},
              ItalicFeatures     = {RawFeature={fallback=texsmith-fallback-reg}},
              BoldItalicFeatures = {RawFeature={fallback=texsmith-fallback-bold}},
            ]{\l_tmpa_tl}
          }{}
      }
    \texsmith_apply_fallback_to_family:nn \setmainfont \rmdefault
    \texsmith_apply_fallback_to_family:nn \setsansfont \sfdefault
    \texsmith_apply_fallback_to_family:nn \setmonofont \ttdefault
    \ExplSyntaxOff
  \else\ifXeTeX
  \BLOCK{- if fallback and fallback.get("transitions") }
  \BLOCK{ set uc_options = ['Latin'] + (fallback.package_options if fallback else []) + ['Devanagari'] }
    \RequirePackage[
      \VAR{ uc_options | join(',\n      ') }
    ]{ucharclasses}
    \makeatletter
    \newcommand{\texsmithFallbackFamily}{\rmfamily}
    \newcommand{\texsmithSetFallbackFamily}[1]{\def\texsmithFallbackFamily{#1}}
    \g@addto@macro\rmfamily{\texsmithSetFallbackFamily{\rmfamily}}
    \g@addto@macro\sffamily{\texsmithSetFallbackFamily{\sffamily}}
    \g@addto@macro\ttfamily{\texsmithSetFallbackFamily{\ttfamily}}
    \BLOCK{ for entry in fallback.entries }
      \expandafter\g@addto@macro\csname \VAR{entry.font_command}\endcsname{%
        \texsmithSetFallbackFamily{\csname \VAR{entry.font_command}\endcsname}%
      }
    \BLOCK{ endfor }
    \makeatother
    \texsmithSetFallbackFamily{\rmfamily}
    \setDefaultTransitions{\texsmithFallbackFamily}{\texsmithFallbackFamily}%
    \BLOCK{ for transition in fallback.transitions }
    \VAR{transition}
    \BLOCK{ endfor }
    \enableTransitionRules
    \ifdefined\XeTeXinterchartoksstate
      \XeTeXinterchartoksstate=1%
      \AtBeginDocument{\XeTeXinterchartoksstate=1}%
    \fi
    \AtBeginDocument{\enableTransitionRules}%
  \BLOCK{- endif }
  \fi\fi
  \BLOCK{- endif }
\fi
