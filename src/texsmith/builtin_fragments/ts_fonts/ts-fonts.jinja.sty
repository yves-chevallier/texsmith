\BLOCK{ set press_fonts_raw = press.fonts if press is defined and press else None }
\BLOCK{ set press_fonts = press_fonts_raw if press_fonts_raw is mapping else None }
\BLOCK{ set press_fonts_profile = press_fonts_raw if press_fonts_raw is string else None }
\BLOCK{ set fonts_map = fonts if fonts is defined and fonts is mapping else None }
\BLOCK{ set fonts_profile = fonts if fonts is defined and fonts is string else None }
\BLOCK{ set font_profile = font_profile if font_profile is defined and font_profile else None }
\BLOCK{ if not font_profile and fonts_map } \BLOCK{ set font_profile = fonts_map.get("profile") } \BLOCK{ endif }
\BLOCK{ if not font_profile and fonts_profile } \BLOCK{ set font_profile = fonts_profile } \BLOCK{ endif }
\BLOCK{ if not font_profile and press_fonts } \BLOCK{ set font_profile = press_fonts.get("profile") } \BLOCK{ endif }
\BLOCK{ if not font_profile and press_fonts_profile } \BLOCK{ set font_profile = press_fonts_profile } \BLOCK{ endif }
\BLOCK{ if not font_profile } \BLOCK{ set font_profile = "default" } \BLOCK{ endif }
\BLOCK{ set font_profile = font_profile | lower }
\BLOCK{ set main_font = main_font | default("Latin Modern Roman") }
\BLOCK{ set sans_font = sans_font | default("Latin Modern Sans") }
\BLOCK{ set mono_font = mono_font | default("FreeMono") }
\BLOCK{ set math_font = math_font | default("Latin Modern Math") }
\BLOCK{ set small_caps_font = small_caps_font | default("Latin Modern Roman Caps") }
\BLOCK{ set mono_italic = mono_italic | default("* Italic") }
\BLOCK{ set mono_bold_italic = mono_bold_italic | default("* Bold Italic") }
\BLOCK{ set mono_fake_slant = mono_fake_slant | default(False) }
\BLOCK{ set font_path_prefix = font_path_prefix | default("./") }
\BLOCK{ if font_path_prefix and not font_path_prefix.endswith('/') }
  \BLOCK{ set font_path_prefix = font_path_prefix ~ '/' }
\BLOCK{ endif }
\BLOCK{ set press_fonts = press_fonts if press_fonts is not none else None }
\BLOCK{ set runtime_emoji = emoji_mode if emoji_mode is defined else None }
\BLOCK{ set emoji_pref = emoji if emoji is defined else ((press_fonts.get("emoji") if press_fonts else None) if press_fonts is mapping else None) }
\BLOCK{ if not emoji_pref and runtime_emoji }
  \BLOCK{ set emoji_pref = runtime_emoji }
\BLOCK{ elif not emoji_pref and fonts_map }
  \BLOCK{ set emoji_pref = fonts_map.get("emoji") }
\BLOCK{ endif }
\BLOCK{ set emoji_mode = (emoji_pref | default('black') | lower) }
\BLOCK{ set emoji_disabled = emoji_mode in ["artifact", "off", "none"] }
\BLOCK{ set emoji_twemoji = emoji_mode == "twemoji" }
\BLOCK{ set emoji_font = None }
\BLOCK{ set emoji_renderer = "harf" }
\BLOCK{ if not emoji_disabled and not emoji_twemoji }
  \BLOCK{ if emoji_mode in ["black", "openmoji-black", "openmoji black"] }
    \BLOCK{ set emoji_font = "OpenMoji Black" }
  \BLOCK{ elif emoji_mode in ["color", "colour", "openmoji-color", "openmoji color", "noto color emoji"] }
    \BLOCK{ set emoji_font = "Noto Color Emoji" }
  \BLOCK{ else }
    \BLOCK{ set emoji_font = emoji_pref }
  \BLOCK{ endif }
\BLOCK{ endif }
\BLOCK{ set emoji_range_start = "1F000" }
\BLOCK{ set emoji_range_end = "1FAFF" }
\BLOCK{ set emoji_ranges = emoji_ranges if emoji_ranges is defined and emoji_ranges else [(emoji_range_start, emoji_range_end)] }
\BLOCK{ set font_files = font_files | default({}) }
\BLOCK{ set unicode_font_classes = unicode_font_classes | default([]) }
\BLOCK{ set fallback_fonts = fallback_fonts | default(
  ["NotoSans", "NotoSansSymbols2-Regular", "NotoSansMath-Regular"], true) }
\BLOCK{ set _emoji_filtered = namespace(items=[]) }
\BLOCK{ for font in fallback_fonts }
  \BLOCK{ if "notocoloremoji" not in font|lower }
    \BLOCK{ set _ = _emoji_filtered.items.append(font) }
  \BLOCK{ endif }
\BLOCK{ endfor }
\BLOCK{ set fallback_fonts = _emoji_filtered.items }
\BLOCK{ if emoji_font and emoji_font not in fallback_fonts }
  \BLOCK{ set fallback_fonts = [emoji_font] + fallback_fonts }
\BLOCK{ endif }
\BLOCK{ set emoji_files = font_files.get(emoji_font, {}) if emoji_font else {} }
\BLOCK{ if mono_font == "FreeMono" }
  \BLOCK{ set mono_italic = "* Oblique" }
  \BLOCK{ set mono_bold_italic = "* Bold Oblique" }
\BLOCK{ endif }
\BLOCK{ if font_profile == "sans" and main_font == "Latin Modern Roman" }
  \BLOCK{ set main_font = "Latin Modern Sans" }
  \BLOCK{ set sans_font = "Latin Modern Sans" }
  \BLOCK{ set mono_font = "IBM Plex Mono" }
\BLOCK{ elif font_profile == "adventor" and main_font == "Latin Modern Roman" }
  \BLOCK{ set main_font = "TeX Gyre Adventor" }
  \BLOCK{ set sans_font = "TeX Gyre Adventor" }
  \BLOCK{ set mono_font = "IBM Plex Mono" }
  \BLOCK{ set math_font = "TeX Gyre Pagella Math" }
  \BLOCK{ set small_caps_font = None }
\BLOCK{ elif font_profile == "heros" and main_font == "Latin Modern Roman" }
  \BLOCK{ set main_font = "TeX Gyre Heros" }
  \BLOCK{ set sans_font = "TeX Gyre Heros" }
  \BLOCK{ set mono_font = "IBM Plex Mono" }
  \BLOCK{ set math_font = "TeX Gyre Pagella Math" }
  \BLOCK{ set small_caps_font = None }
\BLOCK{ elif font_profile == "noto" and main_font == "Latin Modern Roman" }
  \BLOCK{ set main_font = "Noto Serif" }
  \BLOCK{ set sans_font = "Noto Sans" }
  \BLOCK{ set mono_font = "Noto Sans Mono" }
  \BLOCK{ set math_font = "Noto Sans Math" }
  \BLOCK{ set small_caps_font = None }
  \BLOCK{ set mono_italic = "*" }
  \BLOCK{ set mono_bold_italic = "* Bold" }
  \BLOCK{ set mono_fake_slant = True }
\BLOCK{ endif }
\BLOCK{ if font_profile in ["adventor", "heros"] }
  \BLOCK{ set small_caps_font = None }
\BLOCK{ endif }
\ProvidesPackage{ts-fonts}[2025/11/21 TeXSmith Unified font setup (generated)]

% This file is a Jinja2 template. Render it to a .sty before use.
% Context expected:
%   - fallback_fonts: list of font family names (LuaLaTeX fallbacks)
%   - present_fonts: list (optional, informational)
%   - missing_fonts: list (optional, informational)

\RequirePackage{iftex}
\providecommand{\texsmithEmoji}[1]{#1}

\ifPDFTeX
  \RequirePackage[T1]{fontenc}
  \RequirePackage[utf8]{inputenc}
  \RequirePackage{lmodern}
  \RequirePackage{amssymb}
  \RequirePackage{microtype}
  \microtypesetup{expansion=true,protrusion=true}
\else
  \RequirePackage{fontspec}
  \RequirePackage{microtype}
  \defaultfontfeatures{
    Ligatures = TeX,
    Scale = MatchLowercase,
  }
\BLOCK{ set main_files = font_files.get(main_font, {}) }
\BLOCK{ set sans_files = font_files.get(sans_font, {}) }
\BLOCK{ set mono_files = font_files.get(mono_font, {}) }
\BLOCK{ set math_files = font_files.get(math_font, {}) }
\BLOCK{ set small_caps_files = font_files.get(small_caps_font, {}) if small_caps_font else {} }
\BLOCK{ if not mono_files and mono_font == "IBM Plex Mono" }
  \BLOCK{ set mono_files = {
    "regular": "IBMPlexMono-Regular.ttf",
    "bold": "IBMPlexMono-Bold.ttf",
    "italic": "IBMPlexMono-Italic.ttf",
    "bold_italic": "IBMPlexMono-BoldItalic.ttf"
  } }
\BLOCK{ endif }
  \ifLuaTeX
    \let\eth\relax
    \let\Eth\relax
    \RequirePackage{amssymb}
    \RequirePackage{unicode-math}
    \UseMicrotypeSet[protrusion]{basicmath}
\directlua{
      luaotfload.add_fallback("mainfb-reg", {
\BLOCK{ for font in fallback_fonts }
        \BLOCK{ set files = font_files.get(font, {}) }
        \BLOCK{ set reg_font = files.get("regular") }
        \BLOCK{ set is_emoji_font = (emoji_font and font == emoji_font) }
        \BLOCK{ set fallback_mode = "harf" if is_emoji_font else "node" }
        \BLOCK{ if reg_font }
        "[\VAR{font_path_prefix}\VAR{reg_font}]:mode=\VAR{fallback_mode}",
        \BLOCK{ else }
        "\VAR{font}:mode=\VAR{fallback_mode}",
        \BLOCK{ endif }
\BLOCK{ endfor }
      })
      luaotfload.add_fallback("mainfb-bold", {
\BLOCK{ for font in fallback_fonts }
        \BLOCK{ set files = font_files.get(font, {}) }
        \BLOCK{ set bold_font = files.get("bold") or files.get("regular") }
        \BLOCK{ set is_emoji_font = (emoji_font and font == emoji_font) }
        \BLOCK{ set fallback_mode = "harf" if is_emoji_font else "node" }
        \BLOCK{ if bold_font }
        "[\VAR{font_path_prefix}\VAR{bold_font}]:mode=\VAR{fallback_mode}",
        \BLOCK{ else }
        "\VAR{font}/B:mode=\VAR{fallback_mode}",
        \BLOCK{ endif }
\BLOCK{ endfor }
      })
      luaotfload.add_fallback("mainfb-it", {
\BLOCK{ for font in fallback_fonts }
        \BLOCK{ set files = font_files.get(font, {}) }
        \BLOCK{ set italic_font = files.get("italic") or files.get("regular") }
        \BLOCK{ set is_emoji_font = (emoji_font and font == emoji_font) }
        \BLOCK{ set fallback_mode = "harf" if is_emoji_font else "node" }
        \BLOCK{ if italic_font }
        "[\VAR{font_path_prefix}\VAR{italic_font}]:mode=\VAR{fallback_mode}",
        \BLOCK{ else }
        "\VAR{font}/I:mode=\VAR{fallback_mode}",
        \BLOCK{ endif }
\BLOCK{ endfor }
      })
      luaotfload.add_fallback("mainfb-bi", {
\BLOCK{ for font in fallback_fonts }
        \BLOCK{ set files = font_files.get(font, {}) }
        \BLOCK{ set bold_italic_font = files.get("bold_italic") or files.get("bold") or files.get("italic") or files.get("regular") }
        \BLOCK{ set is_emoji_font = (emoji_font and font == emoji_font) }
        \BLOCK{ set fallback_mode = "harf" if is_emoji_font else "node" }
        \BLOCK{ if bold_italic_font }
        "[\VAR{font_path_prefix}\VAR{bold_italic_font}]:mode=\VAR{fallback_mode}",
        \BLOCK{ else }
        "\VAR{font}/BI:mode=\VAR{fallback_mode}",
        \BLOCK{ endif }
\BLOCK{ endfor }
      })
    }
    \setmainfont{\VAR{main_font}}[
      Ligatures=TeX,
\BLOCK{ if main_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
\BLOCK{ if main_files.get("regular") }
      UprightFont = {\VAR{main_files["regular"]}},
\BLOCK{ endif }
\BLOCK{ if small_caps_font }
      SmallCapsFont = {\VAR{small_caps_files.get("regular", small_caps_font)}},
\BLOCK{ endif }
\BLOCK{ if main_files.get("bold") }
      BoldFont = {\VAR{main_files["bold"]}},
\BLOCK{ endif }
\BLOCK{ if main_files.get("italic") }
      ItalicFont = {\VAR{main_files["italic"]}},
\BLOCK{ endif }
\BLOCK{ if main_files.get("bold_italic") }
      BoldItalicFont = {\VAR{main_files["bold_italic"]}},
\BLOCK{ endif }
      RawFeature = {fallback=mainfb-reg},
      BoldFeatures = {RawFeature={fallback=mainfb-bold}},
      ItalicFeatures = {RawFeature={fallback=mainfb-it}},
      BoldItalicFeatures = {RawFeature={fallback=mainfb-bi}},
    ]
    \setsansfont{\VAR{sans_font}}[
      Ligatures=TeX,
\BLOCK{ if sans_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("regular") }
      UprightFont = {\VAR{sans_files["regular"]}},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("bold") }
      BoldFont = {\VAR{sans_files["bold"]}},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("italic") }
      ItalicFont = {\VAR{sans_files["italic"]}},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("bold_italic") }
      BoldItalicFont = {\VAR{sans_files["bold_italic"]}},
\BLOCK{ endif }
      RawFeature = {fallback=mainfb-reg},
      BoldFeatures  = {RawFeature={fallback=mainfb-bold}},
      ItalicFeatures = {RawFeature={fallback=mainfb-it}},
      BoldItalicFeatures = {RawFeature={fallback=mainfb-bi}},
      SmallCapsFeatures = {Letters=SmallCaps},
    ]
    \setmonofont{\VAR{mono_font}}[
      Scale=0.9,
      Ligatures=TeX,
\BLOCK{ if mono_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
      UprightFont={\VAR{mono_files.get("regular", mono_font)}},
      ItalicFont={\VAR{mono_files.get("italic", mono_italic)}},
      BoldFont={\VAR{mono_files.get("bold", "* Bold")}},
      BoldItalicFont={\VAR{mono_files.get("bold_italic", mono_bold_italic)}},
      RawFeature = {fallback=mainfb-reg},
      BoldFeatures = {RawFeature={fallback=mainfb-bold}},
      SmallCapsFeatures = {Letters=SmallCaps},
      ItalicFeatures = {
        RawFeature={fallback=mainfb-it},
\BLOCK{ if mono_fake_slant }
        FakeSlant=0.2,
\BLOCK{ endif }
      },
      BoldItalicFeatures = {
        RawFeature={fallback=mainfb-bi},
\BLOCK{ if mono_fake_slant }
        FakeSlant=0.2,
\BLOCK{ endif }
      },
    ]
\BLOCK{ set math_target = math_files.get("regular", math_font) }
\setmathfont{\VAR{math_target}}[
\BLOCK{ if math_files }
  Path=\VAR{font_path_prefix},
\BLOCK{ endif }
  RawFeature = {fallback=mainfb-reg},
  BoldFeatures = {RawFeature={fallback=mainfb-bold}},
  ItalicFeatures = {RawFeature={fallback=mainfb-it}},
]
% Emoji handling (LuaLaTeX): rely on luaotfload fallbacks, optional twemoji.
\BLOCK{ if emoji_twemoji }
  \RequirePackage{twemoji}
  \renewcommand{\texsmithEmoji}[1]{\twemoji{#1}}
\BLOCK{ elif emoji_font }
  % Fallback already covers emoji; keep macro a passthrough.
  \newfontfamily\texsmithEmojiFont{\VAR{emoji_font}}[
\BLOCK{ if emoji_files }
    Path=\VAR{font_path_prefix},
\BLOCK{ endif }
\BLOCK{ if emoji_files.get("regular") }
    UprightFont={\VAR{emoji_files["regular"]}},
\BLOCK{ endif }
    Renderer=Harfbuzz,
    Scale=1.05
  ]
  \renewcommand{\texsmithEmoji}[1]{#1}
\BLOCK{ else }
  \renewcommand{\texsmithEmoji}[1]{#1}
\BLOCK{ endif }
  \else
    % XeLaTeX/Tectonic path: rely on ucharclasses for glyph coverage.
    \let\eth\relax
    \let\Eth\relax
    \RequirePackage{amssymb}
    \RequirePackage{unicode-math}
\BLOCK{ set needs_uchar = (unicode_font_classes and unicode_font_classes|length > 0) or (emoji_font is not none) }
\BLOCK{ if needs_uchar }
    \RequirePackage{ucharclasses}
\makeatletter
\providecommand{\newUnicodeClass}[1]{%
  \expandafter\newXeTeXintercharclass\csname #1Class\endcsname
  \ifnum\csname #1Class\endcsname>\@classend
    \chardef\@classend=\csname #1Class\endcsname
  \fi
}
\providecommand{\setUnicodeClassRange}[3]{%
  \count@="#2\relax
  \loop
    \XeTeXcharclass\count@=\csname #1Class\endcsname
    \ifnum\count@<"#3\relax
      \advance\count@\@ne
  \repeat
}
\makeatother
\BLOCK{ endif }
    \setmainfont{\VAR{main_font}}[
      Ligatures=TeX,
\BLOCK{ if main_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
\BLOCK{ if main_files.get("regular") }
      UprightFont = {\VAR{main_files["regular"]}},
\BLOCK{ endif }
\BLOCK{ if small_caps_font }
      SmallCapsFont = {\VAR{small_caps_files.get("regular", small_caps_font)}},
\BLOCK{ endif }
\BLOCK{ if main_files.get("bold") }
      BoldFont = {\VAR{main_files["bold"]}},
\BLOCK{ endif }
\BLOCK{ if main_files.get("italic") }
      ItalicFont = {\VAR{main_files["italic"]}},
\BLOCK{ endif }
\BLOCK{ if main_files.get("bold_italic") }
      BoldItalicFont = {\VAR{main_files["bold_italic"]}},
\BLOCK{ endif }
    ]
    \setsansfont{\VAR{sans_font}}[
      Ligatures=TeX,
\BLOCK{ if sans_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("regular") }
      UprightFont = {\VAR{sans_files["regular"]}},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("bold") }
      BoldFont = {\VAR{sans_files["bold"]}},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("italic") }
      ItalicFont = {\VAR{sans_files["italic"]}},
\BLOCK{ endif }
\BLOCK{ if sans_files.get("bold_italic") }
      BoldItalicFont = {\VAR{sans_files["bold_italic"]}},
\BLOCK{ endif }
    ]
    \setmonofont{\VAR{mono_font}}[
      Scale=0.9,
      Ligatures=TeX,
\BLOCK{ if mono_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
      UprightFont={\VAR{mono_files.get("regular", mono_font)}},
      ItalicFont={\VAR{mono_files.get("italic", mono_italic)}},
      BoldFont={\VAR{mono_files.get("bold", "* Bold")}},
      BoldItalicFont={\VAR{mono_files.get("bold_italic", mono_bold_italic)}},
\BLOCK{ if mono_fake_slant }
      FakeSlant=0.2,
\BLOCK{ endif }
    ]
    \setmathfont{\VAR{math_files.get("regular", math_font)}}[
\BLOCK{ if math_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
    ]
\BLOCK{ if unicode_font_classes }
\BLOCK{ for class in unicode_font_classes }
\BLOCK{ set is_emoji_class = emoji_font and class.family|lower == "notocoloremoji" }
\BLOCK{ set class_family = emoji_font if is_emoji_class else class.family }
\BLOCK{ set class_files = emoji_files if is_emoji_class else class.files }
\BLOCK{ set class_ranges = class.ranges }
\expandafter\newfontfamily\csname \VAR{class.font_command}\endcsname[
\BLOCK{ if class_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
\BLOCK{ if class_files.get("regular") }
      UprightFont={\VAR{class_files["regular"]}},
\BLOCK{ endif }
\BLOCK{ if class_files.get("bold") }
      BoldFont={\VAR{class_files["bold"]}},
\BLOCK{ endif }
\BLOCK{ if class_files.get("italic") }
      ItalicFont={\VAR{class_files["italic"]}},
\BLOCK{ endif }
\BLOCK{ if class_files.get("bold_italic") }
      BoldItalicFont={\VAR{class_files["bold_italic"]}},
\BLOCK{ endif }
    ]{\VAR{class_family}}
    \newUnicodeClass{\VAR{class.class_name}}
\setTransitionTo{\VAR{class.class_name}}{\csname \VAR{class.font_command}\endcsname}
    \setTransitionFrom{\VAR{class.class_name}}{\rmfamily}
\BLOCK{ for start, end in class_ranges }
    \setUnicodeClassRange{\VAR{class.class_name}}{\VAR{start}}{\VAR{end}}
\BLOCK{ endfor }
\BLOCK{ endfor }
\BLOCK{ endif }
\BLOCK{ if emoji_font }
    \newfontfamily\texsmithEmojiFont{\VAR{emoji_font}}[
\BLOCK{ if emoji_files }
      Path=\VAR{font_path_prefix},
\BLOCK{ endif }
\BLOCK{ if emoji_files.get("regular") }
      UprightFont={\VAR{emoji_files["regular"]}},
\BLOCK{ endif }
      Renderer=Harfbuzz,
      Scale=1.05
    ]
    \renewcommand{\texsmithEmoji}[1]{{\texsmithEmojiFont #1}}
\BLOCK{ elif emoji_twemoji }
    \RequirePackage{twemoji}
    \renewcommand{\texsmithEmoji}[1]{\twemoji{##1}}
\BLOCK{ else }
    \renewcommand{\texsmithEmoji}[1]{##1}
\BLOCK{ endif }
\BLOCK{ if emoji_font }
    \newUnicodeClass{Emoji}
\setTransitionTo{Emoji}{\texsmithEmojiFont}
    \setTransitionFrom{Emoji}{\rmfamily}
    \BLOCK{ for start, end in emoji_ranges }
    \setUnicodeClassRange{Emoji}{\VAR{start}}{\VAR{end}}
    \BLOCK{ endfor }
\BLOCK{ endif }
  \fi
\fi
