\documentclass[
  paper=a4,
  fontsize=11pt,
  parskip=half,
  fromalign=left,
  fromrule=afteraddress,
  enlargefirstpage=true,
  subject=beforeopening,
]{scrlttr2}
\usepackage{fontspec}
\usepackage[\VAR{babel_language|default('english')}]{babel}
\usepackage{csquotes}
\usepackage{amsmath}
\usepackage{adjustbox}
\providecommand{\texsmithCalloutStyle}{fancy}
\renewcommand{\texsmithCalloutStyle}{\VAR{callout_style|default('fancy')}}
\usepackage{callouts}
\LoadLetterOption{\VAR{letter_standard_option}}
\KOMAoptions{foldmarks=\VAR{foldmarks_option}}
\BLOCK{ set margin_style = margin|default('default')|lower }
\BLOCK{ set margin_literal = margin_style not in ["narrow", "default", "wide"] }
\BLOCK{ if margin_style == "narrow" }
\KOMAoptions{fromalign=left, backaddress=false}
\setlength{\oddsidemargin}{1cm}
\BLOCK{ elif margin_style == "wide" }
\KOMAoptions{fromalign=left, backaddress=false}
\setlength{\oddsidemargin}{2cm}
\BLOCK{ elif margin_literal }
\KOMAoptions{fromalign=left, backaddress=false}
\setlength{\oddsidemargin}{0cm}
\addtolength{\textwidth}{-\VAR{margin}}
\BLOCK{ endif }
\BLOCK{ if use_cursive_signature }
\setmainfont[Path=fonts/,Extension=.otf,Ligatures=Common,Mapping=]{modernline}
\newcommand{\TexsmithLetterEndash}{\kern0.05em-\kern0.05em}
\newcommand{\TexsmithLetterEmdash}{\kern0.05em-\kern0.05em-\kern0.05em}
\catcode"2013=\active
\catcode"2014=\active
\begingroup\lccode`~="2013\lowercase{\endgroup\protected\def~}{\TexsmithLetterEndash}
\begingroup\lccode`~="2014\lowercase{\endgroup\protected\def~}{\TexsmithLetterEmdash}
\BLOCK{ endif }

\BLOCK{ if preamble }
% Custom document preamble injected from overrides.
\VAR{preamble}

\BLOCK{ endif }

\BLOCK{ if use_cursive_signature }
\newfontfamily\SignatureFont[Path=fonts/,Extension=.otf]{modernline}
\newcommand{\SignatureText}[1]{{\SignatureFont #1}}
\BLOCK{ else }
\newcommand{\SignatureText}[1]{#1}
\BLOCK{ endif }

\setkomavar{fromname}{\VAR{from_name}}
\setkomavar{fromaddress}{%
\BLOCK{ if has_sender_address }
\BLOCK{ for line in from_address_lines }
\VAR{line}\BLOCK{ if not loop.last }\\\BLOCK{ endif }
\BLOCK{ endfor }
\BLOCK{ endif }
}
\BLOCK{ if from_location_value }\setkomavar{location}{\VAR{from_location_value}}\BLOCK{ endif }
\setkomavar{date}{\VAR{date_value}}
\BLOCK{ if has_subject }
\setkomavar{subject}{\VAR{object_value}}
\setkomavar*{subject}{\VAR{subject_prefix}}
\BLOCK{ endif }
\setkomavar{signature}{\SignatureText{\VAR{signature_text}}}

\begin{document}

\begin{letter}{%
\BLOCK{ if has_recipient_address }
\BLOCK{ for line in to_address_lines }
\VAR{line}\BLOCK{ if not loop.last }\\\BLOCK{ endif }
\BLOCK{ endfor }
\BLOCK{ else }
\VAR{to_name}
\BLOCK{ endif }
}

\opening{\VAR{opening_text}}

\VAR{mainmatter}

\closing{%
\VAR{closing_text}%
\\[2\baselineskip]%
\SignatureText{\VAR{signature_text}}%
}

\end{letter}
\BLOCK{ if not page_numbers }
\pagenumbering{gobble}
\thispagestyle{empty}
\pagestyle{empty}
\BLOCK{ endif }

\end{document}
