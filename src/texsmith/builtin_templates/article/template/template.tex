\documentclass\VAR{documentclass_options}{article}

\VAR{extra_packages}
\BLOCK{ if latex_engine != "lualatex" }
\BLOCK{ if pdflatex_extra_packages }
\BLOCK{ for package in pdflatex_extra_packages }
\usepackage{\VAR{package}}
\BLOCK{ endfor }
\BLOCK{ endif }
\BLOCK{ endif }

\usepackage{geometry}
\usepackage{hyphenat}
\usepackage[\VAR{language|default('english')}]{babel}
\usepackage{booktabs}
\usepackage{csquotes}
\usepackage{amsmath}
\usepackage[normalem]{ulem} % Strikethrough text with \sout{}
\usepackage{soul} % Highlighting text with \hl{}
\usepackage{keystroke} % Keystroke package
\usepackage{todolist}
\usepackage{progressbar}
\usepackage{float}
\usepackage{hyperref}
\usepackage{bookmark}
\usepackage{adjustbox}
\providecommand{\texsmithEmoji}[1]{#1}

\BLOCK{ if bibliography_resource }
\usepackage[
  backend=biber,
  style=\VAR{bibliography_style|default('numeric')},
]{biblatex}
\addbibresource{\VAR{bibliography_resource}}
\BLOCK{ endif }

\BLOCK{ if acronyms }
\usepackage[acronym,nomain]{glossaries}
\makeglossaries
\BLOCK{ endif }
\BLOCK{ if has_index or index_entries }
\BLOCK{ set resolved_index_engine = index_engine|default('makeindex') }
\BLOCK{ if resolved_index_engine == "texindy" }\usepackage[xindy]{imakeidx}
\BLOCK{ else }\usepackage{imakeidx}
\BLOCK{ endif }
\BLOCK{ endif }

\BLOCK{ set emoji_mode = (emoji | default('artifact') | lower) }
\BLOCK{ if latex_engine == "lualatex" }
\BLOCK{ if emoji_mode == "symbola" }
\IfFontExistsTF{Symbola}{
  \newfontfamily\texsmithEmojiFont{Symbola}[Scale=1.0]
  \renewcommand{\texsmithEmoji}[1]{{\texsmithEmojiFont #1}}
}{
  \renewcommand{\texsmithEmoji}[1]{#1}
}
\BLOCK{ elif emoji_mode == "color" }
\IfFontExistsTF{Noto Color Emoji}{
  \newfontfamily\texsmithEmojiFont{Noto Color Emoji}[Renderer=Harfbuzz,Scale=1.1]
  \renewcommand{\texsmithEmoji}[1]{{\texsmithEmojiFont #1}}
}{
  \renewcommand{\texsmithEmoji}[1]{#1}
}
\BLOCK{ endif }
\BLOCK{ endif }

\usemintedstyle{bw}

\newtcblisting[auto counter,number within=section,
  list inside=mypyg]{code}[4][]{%
  breakable,
  listing only,
  enhanced,
  colback=white,
  colframe=black!90,
  colbacktitle=white,
  coltitle=black,
  pad at break*=1mm,
  toptitle=0.15em,
  bottomtitle=0.1em,
  boxrule=0.07em,
  fonttitle=\bfseries,
  minted language=#2,
  top=1mm,
  arc=0.5mm,
  bottom=1mm,
  minted options={%
      tabsize=4,
      breaklines,
      xleftmargin=-0.75em,
      fontsize=\footnotesize,
      highlightcolor=gray!30,
      ignorelexererrors,
      #4
    },
  before title={\hspace*{-0.9em}},
  title={#3},
  list entry={\protect\numberline{\thetcbcounter}#3},
  #1
}

\BLOCK{ if preamble }
% Custom document preamble injected from front matter overrides.
\VAR{preamble}

\BLOCK{ endif }

\BLOCK{ set margin_style = margin|default('default')|lower }
\BLOCK{ set margin_literal = margin_style not in ["narrow", "default", "wide"] }
\BLOCK{ set geometry_extra = geometry_extra_options|default('')|trim }
\BLOCK{ if margin_style == "narrow" }
\geometry{margin=1.5cm\BLOCK{ if geometry_extra },\VAR{geometry_extra}\BLOCK{ endif }}
\BLOCK{ elif margin_style == "wide" }
\geometry{margin=3.0cm\BLOCK{ if geometry_extra },\VAR{geometry_extra}\BLOCK{ endif }}
\BLOCK{ elif margin_literal }
\geometry{margin=\VAR{margin}\BLOCK{ if geometry_extra },\VAR{geometry_extra}\BLOCK{ endif }}
\BLOCK{ else }
\geometry{\VAR{geometry_options}}
\BLOCK{ endif }

\BLOCK{ set has_title_metadata = title|default('')|trim }
\BLOCK{ if has_title_metadata }
\title{\VAR{title}\BLOCK{ if subtitle }\\\large \VAR{subtitle}\BLOCK{ endif }}
\BLOCK{ if author }\author{\VAR{author}}\BLOCK{ else }\author{}\BLOCK{ endif }
\date{\VAR{date}}
\BLOCK{ endif }

\BLOCK{ if acronyms }
\BLOCK{ for key, entry in acronyms.items() }
\BLOCK{ set pair = entry if (entry is sequence and not entry is string) else [key, entry] }
\newacronym{\VAR{key}}{\VAR{pair[0]|latex_escape}}{\VAR{pair[1]|latex_escape}}
\BLOCK{ endfor }
\BLOCK{ endif }

\BLOCK{ if has_index or index_entries }\makeindex\BLOCK{ endif }

\begin{document}

\BLOCK{ if has_title_metadata }
\maketitle
\BLOCK{ endif }
\BLOCK{ if not page_numbers }
\pagenumbering{gobble}
\thispagestyle{empty}
\pagestyle{empty}
\BLOCK{ endif }

\BLOCK{ if abstract }
\begin{abstract}
\VAR{abstract}
\end{abstract}
\BLOCK{ endif }
\BLOCK{ if toc }
\tableofcontents
\BLOCK{ endif }

\VAR{mainmatter}

\BLOCK{ if acronyms }\printglossary[type=\acronymtype, title=List of Acronyms]\BLOCK{ endif }
\BLOCK{ if has_index or index_entries }\printindex\BLOCK{ endif }

\BLOCK{ if citations and bibliography_resource }
\printbibliography
\BLOCK{ endif }

\end{document}
