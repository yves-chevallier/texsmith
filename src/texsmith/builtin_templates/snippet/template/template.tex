\documentclass[border=0pt]{standalone}

\BLOCK{ if latex_engine == "lualatex" }
\usepackage{fontspec}
\BLOCK{ set base_font_fallbacks = [
    "NotoColorEmoji:mode=harf;",
    "NotoNaskhArabic:mode=harf;",
    "NotoSerifHebrew:mode=harf;",
    "NotoSerifDevanagari:mode=harf;",
    "NotoSerifTamil:mode=harf;",
    "NotoSerifTibetan:mode=harf;",
    "NotoSerifCJKkr:mode=harf;",
    "NotoSans:mode=harf;",
    "NotoSansSymbols2-Regular:mode=harf;",
    "NotoSansMath-Regular:mode=harf;",
    "NotoMusic-Regular:mode=harf;"
] }
\directlua{luaotfload.add_fallback
  ("snippetfallback",
  {
      \BLOCK{ for font in base_font_fallbacks }
      "\VAR{font}"\BLOCK{ if not loop.last },\BLOCK{ endif }
      \BLOCK{ endfor }
  }
  )}

\setmainfont{Latin Modern Roman}[
  Ligatures=TeX,
  SmallCapsFont = Latin Modern Roman Caps,
  RawFeature = {fallback=snippetfallback},
]

\setsansfont{Latin Modern Sans}[
  RawFeature={fallback=snippetfallback}
]

\setmonofont{FreeMono}[
  Scale=0.9,
  ItalicFont={* Oblique},
  BoldFont={* Bold},
  BoldItalicFont={* Bold Oblique},
  RawFeature={fallback=snippetfallback}
]
\BLOCK{ set emoji_mode = (emoji | default('artifact') | lower) }
\BLOCK{ if emoji_mode == "symbola" }
\IfFontExistsTF{Symbola}{
  \newfontfamily\texsmithEmojiFont{Symbola}[Scale=1.0]
  \renewcommand{\texsmithEmoji}[1]{{\texsmithEmojiFont #1}}
}{
  \renewcommand{\texsmithEmoji}[1]{#1}
}
\BLOCK{ elif emoji_mode == "color" }
\IfFontExistsTF{Noto Color Emoji}{
  \newfontfamily\texsmithEmojiFont{Noto Color Emoji}[Renderer=Harfbuzz,Scale=1.1]
  \renewcommand{\texsmithEmoji}[1]{{\texsmithEmojiFont #1}}
}{
  \renewcommand{\texsmithEmoji}[1]{#1}
}
\BLOCK{ else }
\providecommand{\texsmithEmoji}[1]{#1}
\BLOCK{ endif }
\BLOCK{ else }
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\providecommand{\texsmithEmoji}[1]{#1}
\BLOCK{ endif }

\usepackage{microtype}
\usepackage{hyphenat}
\usepackage[\VAR{language|default('english')}]{babel}
\usepackage{booktabs}
\usepackage[many,minted]{tcolorbox}
\usepackage{csquotes}
\usepackage[normalem]{ulem}
\providecommand{\texsmithCalloutStyle}{fancy}
\renewcommand{\texsmithCalloutStyle}{\VAR{callout_style|default('fancy')}}
\usepackage{callouts}
\usepackage{soul}
\usepackage{keystroke}
\usepackage{todolist}
\usepackage{progressbar}
\usepackage{hyperref}
\usepackage{tikz}
\usetikzlibrary{calc}
\providecommand{\texsmithEmoji}[1]{#1}

\BLOCK{ if bibliography_resource }
\usepackage[
  backend=biber,
  style=\VAR{bibliography_style|default('numeric')},
]{biblatex}
\addbibresource{\VAR{bibliography_resource}}
\BLOCK{ endif }

\BLOCK{ if acronyms }
\usepackage[acronym,nomain]{glossaries}
\makeglossaries
\BLOCK{ endif }
\BLOCK{ if has_index or index_entries }
\BLOCK{ set resolved_index_engine = index_engine|default('makeindex') }
\BLOCK{ if resolved_index_engine == "texindy" }\usepackage[xindy]{imakeidx}
\BLOCK{ else }\usepackage{imakeidx}
\BLOCK{ endif }
\BLOCK{ endif }

\usemintedstyle{bw}

\newtcblisting[auto counter,number within=section,
  list inside=mypyg]{code}[4][]{%
  breakable,
  listing only,
  enhanced,
  colback=white,
  colframe=black!90,
  colbacktitle=white,
  coltitle=black,
  pad at break*=1mm,
  toptitle=0.15em,
  bottomtitle=0.1em,
  boxrule=0.07em,
  fonttitle=\bfseries,
  minted language=#2,
  top=1mm,
  arc=0.5mm,
  bottom=1mm,
  minted options={%
      tabsize=4,
      breaklines,
      xleftmargin=-0.75em,
      fontsize=\footnotesize,
      highlightcolor=gray!30,
      ignorelexererrors,
      #4
    },
  before title={\hspace*{-0.9em}},
  title={#3},
  list entry={\protect\numberline{\thetcbcounter}#3},
  #1
}

\BLOCK{ if preamble }
% Custom snippets can inject LaTeX here.
\VAR{preamble}

\BLOCK{ endif }

\begin{document}

\begin{tikzpicture}
  \def\textwidthbox{\VAR{width}}
  \def\margin{\VAR{margin}}
  \def\e{\VAR{dogear}}

  \node[inner sep=\margin, outer sep=0pt] (content) {%
    \begin{minipage}{\textwidthbox}
\VAR{mainmatter}
    \end{minipage}
  };

  \coordinate (A) at (content.north west);
  \coordinate (B) at (content.north east);
  \coordinate (C) at (content.south east);
  \coordinate (D) at (content.south west);

  \coordinate (Bdown) at ($(B)-(0,\e)$);
  \coordinate (Bleft) at ($(B)-(\e,0)$);
  \coordinate (Corner) at ($(B)-(\e,\e)$);

\BLOCK{ if border }
  \draw (A) -- (Bleft) -- (Bdown) -- (C) -- (D) -- cycle;
  \BLOCK{ if dogear_enabled }
  \draw (Corner)
   .. controls ($(Corner)+(0.3*\e,0.1*\e)$) and ($(Bdown)+(-0.3*\e,-0.1*\e)$) ..
   (Bdown);
  \draw (Bleft)
   .. controls ($(Bleft)+(0.1*\e,-0.3*\e)$) and ($(Corner)+(-0.1*\e,0.3*\e)$) ..
   (Corner);
  \BLOCK{ endif }
\BLOCK{ endif }

\end{tikzpicture}

\BLOCK{ if acronyms }\printglossary[type=\acronymtype, title=List of Acronyms]\BLOCK{ endif }
\BLOCK{ if has_index or index_entries }\printindex\BLOCK{ endif }
\BLOCK{ if citations and bibliography_resource }\printbibliography\BLOCK{ endif }

\end{document}
