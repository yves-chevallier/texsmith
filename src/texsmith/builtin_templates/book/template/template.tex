\documentclass[9pt,twoside]{memoir}

\VAR{extra_packages}
\usepackage[svgnames,dvipsnames,x11names]{xcolor}
\usepackage{tikz}
\usepackage{textcomp} % For ©, ™
\usepackage{amsmath} % For \text
\usepackage{amssymb} % For √, ∞, etc.
\usepackage{gensymb} % For °, ℃, ℉, etc.
\usepackage{nicefrac}
\usepackage{fancyhdr}
\usepackage[normalem]{ulem}
\usepackage{graphicx}
\usepackage{unicode-math}
\usepackage{fontawesome5}
\usepackage{multicol}
\usepackage{stackengine}
\usepackage{booktabs}
\usepackage{minted}
\usepackage{todolist}
\usepackage{keystroke}
\usepackage{csquotes}
\usepackage{epigraph}
\usepackage{capt-of}
\usepackage[acronym,xindy]{glossaries}
\usepackage{imakeidx}
\usepackage{fvextra}
\usepackage{titlesec}
\usepackage{enumitem}
\usepackage{etoolbox}
\usepackage{tocloft}
\usepackage{adjustbox}
\usepackage{caption}
\usepackage[\VAR{language|default('english')}]{babel}
\usepackage{emptypage}
\definecolor{linkcolor}{RGB}{34, 18, 104}
\definecolor{urlcolor}{RGB}{104, 18, 55}

\usepackage[
  colorlinks=true,
  plainpages=true,
  linkcolor=black,
  citecolor=black,
  plainpages=false,
  unicode=true,
  urlcolor=urlcolor]{hyperref}

\usepackage[
  paperwidth=160mm,
  paperheight=240mm,
  top=20mm,
  bottom=20mm,
  left=20mm,
  right=15mm,
  headheight=6mm,
  headsep=5mm,
  marginparsep=4mm,
  heightrounded]{geometry}

\usetikzlibrary{shapes.geometric}
\usetikzlibrary{calc}
\usetikzlibrary{shadows}

\graphicspath{{assets/}}

%
% Adjust spacing
%

% Prevent too many overful \hbox (with some fonts)
\tolerance=2000
\emergencystretch=10pt

% Give more spaces on Table of content (between numbers and text)
\setlength{\cftpartnumwidth}{4em}
\setlength{\cftsectionnumwidth}{3em}
\setlength{\cftsubsectionnumwidth}{3.5em}
\setlength{\cftfigurenumwidth}{3em}
\setlength{\cfttablenumwidth}{3em}

\captionsetup[table]{skip=10pt}

% Make quotations italic and smaller
\AtBeginEnvironment{displayquote}{\small\itshape}

% Fit table to page width
\let\oldtabular\tabular
\let\endoldtabular\endtabular

\newsavebox{\mytablebox}
\renewenvironment{tabular}[1]
  {\begin{lrbox}{\mytablebox}\small\oldtabular{#1}} % Temporary box to store table
  {\endoldtabular\end{lrbox}%
   \ifdim\wd\mytablebox>\linewidth
     \resizebox{\linewidth}{!}{\usebox{\mytablebox}} % Adjust to fit line width
   \else
     \usebox{\mytablebox} % Otherwise, use the table as is
   \fi
  }

% Custom epigraph style
\setlength\epigraphwidth{.8\textwidth}
\setlength\epigraphrule{0pt}

%
% Headers and footers
%

% No line on the footer
\renewcommand{\footrulewidth}{0pt}

% Part head pages
\fancypagestyle{part}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
}

% Chapter head pages
\fancypagestyle{plain}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \fancyfoot[LE,RO]{\thepage}
}

% Mainmatter regular page style
\fancypagestyle{fancy}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0.5pt}
  \fancyhead[LE]{\small\scshape \leftmark}
  \fancyhead[RO]{\small\scshape \rightmark}
  \fancyhead[LO]{\small\scshape \leftmark}
  \fancyhead[RE]{\small\scshape \rightmark}
  \fancyfoot[LE,RO]{\thepage}
}
\makeatletter
\nouppercaseheads
\renewcommand{\chaptermark}[1]{%
  \markboth{\thechapter\quad #1}{}%
}
\renewcommand{\sectionmark}[1]{%
  \markright{\thesection\quad #1}%
}
\makeatother

% Associate the part page style to the part
\patchcmd{\part}{\thispagestyle{plain}}{\thispagestyle{part}}{}{}

\newcommand{\changelocaltocdepth}[1]{%
  \addtocontents{toc}{\protect\setcounter{tocdepth}{#1}}%
  \setcounter{tocdepth}{#1}%
}

\apptocmd{\frontmatter}{%
  \pagestyle{plain}%
  \changelocaltocdepth{1}%
  \setcounter{secnumdepth}{0}
}{}{}

\apptocmd{\mainmatter}{%
  \pagestyle{fancy}%
  \changelocaltocdepth{2}%
  \setcounter{secnumdepth}{2}
}{}{}


%
% Listing / Code configuration
%

\NewTotalTCBox{\cde}{mv}{
  on line,
  boxsep=0pt,
  left=1.5pt,
  right=1.5pt,
  top=1pt,
  bottom=1pt,
  colframe=gray!20,
  colback=gray!20,
  minted options={%
      ignorelexererrors
    },
  rounded corners,
  boxrule=0pt,
}{\mintinline{#1}{#2}}

\newtcolorbox{goodbox}[1][]{
  colback=green!20,
  colframe=green!50!black,
  boxrule=0.5pt,
  arc=4mm,
  auto outer arc,
  #1
}

\newtcolorbox{badbox}[1][]{
  colback=red!20,
  colframe=red!50!black,
  boxrule=0.5pt,
  arc=4mm,
  auto outer arc,
  #1
}

\newtcolorbox{commentbox}[1][]{
  colback=gray!20,
  colframe=gray!50!black,
  boxrule=0.5pt,
  arc=4mm,
  auto outer arc,
  #1
}

%
% Tweaks
%

% Allow hyphenation after a hyphen
\providecommand{\allowhyphens}{\ifvmode\else\nobreak\hspace{0pt}\fi}

% Redefine bullet list character to a dash (demi-cadratin)
\setlist[itemize,1]{label=--}

% To number paragraphs and subparagraphs
\setcounter{secnumdepth}{5}

% Paragraph indentation
% \setlength{\parindent}{0pt}
% \setlength\parskip{\medskipamount}

% Avoid orphans at the end of a page, encourage page breaks if there are
% a section with less than 3 lines
% https://tex.stackexchange.com/a/723704/85416
\makeatletter
\patchcmd\@afterheading{\clubpenalty \@M}{\clubpenalties 3 \@M\@M 5000 }{%
  \typeout{patched}}{\typeout{patch failed}
}
\makeatother

% Allow for short text below parts
% https://tex.stackexchange.com/a/336401/85416
% \makeatletter
% \newcommand{\extraPartText}[1]{\def\@extraPartText{#1}}
% \pretocmd{\@endpart}{\vspace{8ex}\begingroup\centering\@extraPartText\par\endgroup\let\@extraPartText\relax}{}{}
% \makeatother

% Description item and text are displayed by default on the same line
% this is not very readable. This command changes the style to display
% the description text on the next line.
% https://tex.stackexchange.com/a/430454/85416
% https://tex.stackexchange.com/a/726879/85416
\AddToHook{cmd/descriptionlabel/after}{\rule[-8pt]{0pt}{0pt}}
\setlist[description]{
  style=nextline,
  labelindent=0pt,
  leftmargin=1cm,
  itemindent=\dimexpr-5pt-\labelsep\relax
}

% Workaround for mintedinline in item
% https://tex.stackexchange.com/a/723530/85416
\NewDocumentCommand{\minteditem}{mv}{%
  \item[\mintinline{#1}{#2}]%
}

% Highlight text in yellow
\newtcbox{\hl}{on line, boxrule=0.5pt, colframe=black, colback=yellow!30, sharp corners, boxsep=0pt, left=2pt, right=2pt, top=2pt, bottom=2pt}

% For exercises and solutions
\newcommand\correctchoice{\stackinset{c}{}{c}{}{$\times$}{$\bigcirc$}}
\newcommand\choice{$\bigcirc$}


\newcommand{\booktitle}{\VAR{title}}
\newcommand{\booksubtitle}{\VAR{subtitle}}
\newcommand{\bookauthor}{\VAR{author}}
\newcommand{\bookemail}{\VAR{email}}
\newcommand{\bookpublisher}{\VAR{publisher}}
\newcommand{\bookedition}{\VAR{edition}}
\newcommand{\bookdate}{\VAR{date}}

% Preserve convenience macros expected by assets/covers
\newcommand{\subtitle}{\booksubtitle}

\title{\booktitle}
\author{\bookauthor}
\makeatletter
\gdef\@subtitle{\booksubtitle}
\gdef\@authoremail{\bookemail}
\makeatother
\newcommand{\subtitletext}{\booksubtitle}
\newcommand{\authorname}{\bookauthor}
\newcommand{\authoremail}{\bookemail}
\providecommand{\texsmithEmoji}[1]{#1}

\definecolor{indigo(dye)}{rgb}{0.0, 0.25, 0.42}

\BLOCK{ if glossary or acronyms }\makeglossaries\BLOCK{ endif }
\BLOCK{ if glossary }\input{glossary}\BLOCK{ endif }
\BLOCK{ if acronyms }
\BLOCK{ for key, entry in acronyms.items() }
\BLOCK{ set pair = entry if (entry is sequence and not entry is string) else [key, entry] }
\newacronym{\VAR{key}}{\VAR{pair[0]|latex_escape}}{\VAR{pair[1]|latex_escape}}
\BLOCK{ endfor }
\BLOCK{ endif }
\BLOCK{ if index_entries }\makeindex\BLOCK{ endif }

%\input{acronyms}

\begin{document}

\input{titlepage}
\BLOCK{ if imprint_thanks|trim or imprint_license|trim or imprint_copyright|trim }
\cleardoublepage
\input{imprint}
\BLOCK{ endif }

\BLOCK{ if dedication|trim }
\cleardoublepage
\thispagestyle{plain}
\phantomsection
\addcontentsline{toc}{chapter}{Dedication}
\begin{center}
  \vspace*{3cm}
  {\Large\itshape \VAR{dedication}}
\end{center}
\BLOCK{ endif }

\thispagestyle{empty}

\raggedbottom

\frontmatter

\VAR{frontmatter}

\clearpage
\tableofcontents

\mainmatter

\VAR{mainmatter}

\backmatter

\VAR{backmatter}

\BLOCK{ if listoffigures }
\clearpage
\listoffigures
\BLOCK{ endif }
\BLOCK{ if listoftables }
\clearpage
\listoftables
\BLOCK{ endif }

\BLOCK{ if acronyms }\printglossary[type=\acronymtype, title=Liste des acronymes]\BLOCK{ endif }
\BLOCK{ if glossary }\printglossary[title=Termes et définitions]\BLOCK{ endif }
\BLOCK{ if index_entries }\printindex\BLOCK{ endif }

\BLOCK{ if citations }
\begin{thebibliography}{\VAR{citations|length}}
\BLOCK{ for key in citations }
\BLOCK{ set entry = bibliography_entries.get(key) }
\bibitem{\VAR{key}}%
\BLOCK{ if entry }
\BLOCK{ set fields = entry['fields'] }
\BLOCK{ set persons = entry['persons'] }
\BLOCK{ set authors = persons.get('author', []) }
\BLOCK{ if authors }\VAR{ authors | map(attribute='text') | join(', ') }\BLOCK{ endif }%
\BLOCK{ if fields.get('title') } \textit{\VAR{fields['title']}}\BLOCK{ endif }%
\BLOCK{ if fields.get('publisher') } \VAR{fields['publisher']}\BLOCK{ endif }%
\BLOCK{ if fields.get('year') } (\VAR{fields['year']})\BLOCK{ endif }%
\BLOCK{ if fields.get('url') }\\\url{\VAR{fields['url']}}\BLOCK{ endif }
\BLOCK{ else }
Missing bibliography entry for \VAR{key}
\BLOCK{ endif }
\BLOCK{ endfor }
\end{thebibliography}
\BLOCK{ endif }

\BLOCK{ if colophon|trim }
\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{Colophon}
\chapter*{Colophon}
\VAR{colophon}
\BLOCK{ endif }

\end{document}
