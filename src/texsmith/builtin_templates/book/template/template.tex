\documentclass[9pt,twoside]{memoir}

\usepackage{amssymb} % Additional math symbols
\usepackage{nicefrac} % For support of: ½, ⅔...
\usepackage{xurl} % For better URL line breaking reduce overfull hbox

\VAR{extra_packages}
\usepackage[svgnames,dvipsnames,x11names]{xcolor}

\ifLuaTeX
  \usepackage{fontspec}
  \defaultfontfeatures{Scale=MatchLowercase, Ligatures=TeX}
  \IfFontExistsTF{DejaVu Sans Mono}{\setmonofont{DejaVu Sans Mono}}{\setmonofont{Latin Modern Mono}}
\fi

\usepackage{fancyhdr}

\usepackage{graphicx} % For including images
\usepackage{fontawesome5}
\usepackage{multicol}
\usepackage{booktabs}
\usepackage{csquotes}
\usepackage{epigraph}
\usepackage{capt-of}
\usepackage{fvextra}
\usepackage{enumitem}
\usepackage{etoolbox}
\usepackage{tocloft}
\usepackage{caption}
\usepackage[\VAR{language|default('english')}]{babel}
\usepackage{emptypage}
\definecolor{linkcolor}{RGB}{34, 18, 104}
\definecolor{urlcolor}{RGB}{104, 18, 55}

\graphicspath{{assets/}}

%
% Heading style
%
\chapterstyle{default} % ou ton style préféré (vehttp, ell, etc.)

\renewcommand*{\partnamefont}{\normalfont\sffamily\Huge\bfseries\scshape}
\renewcommand*{\partnumfont}{\normalfont\sffamily\Huge\bfseries}
\renewcommand*{\parttitlefont}{\normalfont\sffamily\Huge\bfseries}

\renewcommand*{\chapnamefont}{\normalfont\sffamily\Large\scshape}
\renewcommand*{\chapnumfont}{\normalfont\sffamily\Huge\bfseries}
\renewcommand*{\chaptitlefont}{\normalfont\sffamily\Huge\bfseries}
\setsecheadstyle{\sffamily\Large\bfseries}
\setsubsecheadstyle{\sffamily\large\bfseries}

%
% Adjust spacing
%

% Prevent too many overful \hbox (with some fonts)
\tolerance=2000
\emergencystretch=10pt

% Give more spaces on Table of content (between numbers and text)
\setlength{\cftpartnumwidth}{4em}
\setlength{\cftsectionnumwidth}{3em}
\setlength{\cftsubsectionnumwidth}{3.5em}
\setlength{\cftfigurenumwidth}{3em}
\setlength{\cfttablenumwidth}{3em}

% Make quotations italic and smaller
\AtBeginEnvironment{displayquote}{\small\itshape}

% Fit table to page width
\let\oldtabular\tabular
\let\endoldtabular\endtabular

\newsavebox{\mytablebox}
\renewenvironment{tabular}[1]
  {\begin{lrbox}{\mytablebox}\small\oldtabular{#1}} % Temporary box to store table
  {\endoldtabular\end{lrbox}%
   \ifdim\wd\mytablebox>\linewidth
     \resizebox{\linewidth}{!}{\usebox{\mytablebox}} % Adjust to fit line width
   \else
     \usebox{\mytablebox} % Otherwise, use the table as is
   \fi
  }

% Custom epigraph style
\setlength\epigraphwidth{.8\textwidth}
\setlength\epigraphrule{0pt}

%
% Headers and footers
%

% No line on the footer
\renewcommand{\footrulewidth}{0pt}

% Part head pages
\fancypagestyle{part}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
}

% Chapter head pages
\fancypagestyle{plain}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \fancyfoot[LE,RO]{\thepage}
}

% Mainmatter regular page style
\fancypagestyle{fancy}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0.5pt}
  \fancyhead[LE]{\small\scshape \leftmark}
  \fancyhead[RO]{\small\scshape \rightmark}
  \fancyhead[LO]{\small\scshape \leftmark}
  \fancyhead[RE]{\small\scshape \rightmark}
  \fancyfoot[LE,RO]{\thepage}
}
\makeatletter
\nouppercaseheads
\renewcommand{\chaptermark}[1]{%
  \markboth{\thechapter\quad #1}{}%
}
\renewcommand{\sectionmark}[1]{%
  \markright{\thesection\quad #1}%
}
\makeatother

% Associate the part page style to the part
\patchcmd{\part}{\thispagestyle{plain}}{\thispagestyle{part}}{}{}

\newcommand{\changelocaltocdepth}[1]{%
  \addtocontents{toc}{\protect\setcounter{tocdepth}{#1}}%
  \setcounter{tocdepth}{#1}%
}

\apptocmd{\frontmatter}{%
  \pagestyle{plain}%
  \changelocaltocdepth{1}%
  \setcounter{secnumdepth}{0}
}{}{}

\apptocmd{\mainmatter}{%
  \pagestyle{fancy}%
  \changelocaltocdepth{2}%
  \setcounter{secnumdepth}{2}
}{}{}


%
% Listing / Code configuration
%

\NewTotalTCBox{\cde}{mv}{
  on line,
  boxsep=0pt,
  left=1.5pt,
  right=1.5pt,
  top=1pt,
  bottom=1pt,
  colframe=gray!20,
  colback=gray!20,
  minted options={%
      ignorelexererrors
    },
  rounded corners,
  boxrule=0pt,
}{\mintinline{#1}{#2}}

\newtcolorbox{goodbox}[1][]{
  colback=green!20,
  colframe=green!50!black,
  boxrule=0.5pt,
  arc=4mm,
  auto outer arc,
  #1
}

\newtcolorbox{badbox}[1][]{
  colback=red!20,
  colframe=red!50!black,
  boxrule=0.5pt,
  arc=4mm,
  auto outer arc,
  #1
}

\newtcolorbox{commentbox}[1][]{
  colback=gray!20,
  colframe=gray!50!black,
  boxrule=0.5pt,
  arc=4mm,
  auto outer arc,
  #1
}

%
% Tweaks
%

% Allow hyphenation after a hyphen
\providecommand{\allowhyphens}{\ifvmode\else\nobreak\hspace{0pt}\fi}

% Redefine bullet list character to a dash (demi-cadratin)
\setlist[itemize,1]{label=--}

% To number paragraphs and subparagraphs
\setcounter{secnumdepth}{5}

% Paragraph indentation
% \setlength{\parindent}{0pt}
\setlength\parskip{\smallskipamount}

% Avoid orphans at the end of a page, encourage page breaks if there are
% a section with less than 3 lines
% https://tex.stackexchange.com/a/723704/85416
\makeatletter
\patchcmd\@afterheading{\clubpenalty \@M}{\clubpenalties 3 \@M\@M 5000 }{%
  \typeout{patched}}{\typeout{patch failed}
}
\makeatother

% Allow for short text below parts
% https://tex.stackexchange.com/a/336401/85416
% \makeatletter
% \newcommand{\extraPartText}[1]{\def\@extraPartText{#1}}
% \pretocmd{\@endpart}{\vspace{8ex}\begingroup\centering\@extraPartText\par\endgroup\let\@extraPartText\relax}{}{}
% \makeatother

% Description item and text are displayed by default on the same line
% this is not very readable. This command changes the style to display
% the description text on the next line.
% https://tex.stackexchange.com/a/430454/85416
% https://tex.stackexchange.com/a/726879/85416
\AddToHook{cmd/descriptionlabel/after}{\rule[-8pt]{0pt}{0pt}}
\setlist[description]{
  style=nextline,
  labelindent=0pt,
  leftmargin=1cm,
  itemindent=\dimexpr-5pt-\labelsep\relax
}

% Workaround for mintedinline in item
% https://tex.stackexchange.com/a/723530/85416
\NewDocumentCommand{\minteditem}{mv}{%
  \item[\mintinline{#1}{#2}]%
}

% Highlight text in yellow
\newtcbox{\hl}{on line, boxrule=0.5pt, colframe=black, colback=yellow!30, sharp corners, boxsep=0pt, left=2pt, right=2pt, top=2pt, bottom=2pt}

\newcommand{\booktitle}{\VAR{title}}
\newcommand{\booksubtitle}{\VAR{subtitle}}
\newcommand{\bookauthor}{\VAR{author}}
\newcommand{\bookemail}{\VAR{email}}
\newcommand{\bookpublisher}{\VAR{publisher}}
\newcommand{\bookedition}{\VAR{edition}}
\BLOCK{ set effective_date = date|default('')|trim }
\newcommand{\bookdate}{\BLOCK{ if effective_date }\VAR{date}\BLOCK{ else }\today\BLOCK{ endif }}

% Preserve convenience macros expected by assets/covers
\newcommand{\subtitle}{\booksubtitle}

\title{\booktitle}
\author{\bookauthor}
\makeatletter
\gdef\@subtitle{\booksubtitle}
\gdef\@authoremail{\bookemail}
\makeatother
\newcommand{\subtitletext}{\booksubtitle}
\newcommand{\authorname}{\bookauthor}
\newcommand{\authoremail}{\bookemail}
\providecommand{\texsmithEmoji}[1]{#1}

\definecolor{indigo(dye)}{rgb}{0.0, 0.25, 0.42}

\BLOCK{ if glossary }\input{glossary}\BLOCK{ endif }

%\input{acronyms}

\begin{document}
\hypersetup{pageanchor=false}
\input{titlepage}
\BLOCK{ if imprint_thanks|trim or imprint_license|trim or imprint_copyright|trim }
\cleardoublepage
\input{imprint}
\BLOCK{ endif }

\BLOCK{ if dedication|trim }
\cleardoublepage
\thispagestyle{plain}
\phantomsection
\addcontentsline{toc}{chapter}{Dedication}
\begin{center}
  \vspace*{3cm}
  {\Large\itshape \VAR{dedication}}
\end{center}
\BLOCK{ endif }

\thispagestyle{empty}

\raggedbottom


\frontmatter
\BLOCK{ if preface|trim }
\cleardoublepage
\thispagestyle{plain}
\begingroup
\setsecnumdepth{none}
\phantomsection
\VAR{preface}
\endgroup
\BLOCK{ endif }

\VAR{frontmatter}

\clearpage
\tableofcontents

\hypersetup{pageanchor=true}
\mainmatter

\VAR{mainmatter}

\backmatter

\BLOCK{ if listoffigures }
\ifnum\value{figure}>0
\clearpage
\listoffigures
\fi
\BLOCK{ endif }
\BLOCK{ if listoftables }
\ifnum\value{table}>0
\clearpage
\listoftables
\fi
\BLOCK{ endif }

\VAR{backmatter}
\VAR{fragment_backmatter}

\BLOCK{ if colophon|trim }
\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{Colophon}
\chapter*{Colophon}
\VAR{colophon}
\BLOCK{ endif }

\end{document}
